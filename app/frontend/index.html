<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quiz Online</title>
    <style>
        body { font-family: Arial; max-width: 700px; margin: auto; padding: 20px; }
        .hidden { display: none; }
        .answer { margin: 8px 0; padding: 8px; border: 1px solid #ddd; cursor: pointer; }
        .answer.selected { background: #d0ebff; border-color: #74c0fc; }
        #timer { font-size: 20px; font-weight: bold; color: red; }
    </style>
</head>
<body>

<h2>B√†i thi tr·∫Øc nghi·ªám</h2>
<div id="timer"></div>

<!-- N√∫t b·∫Øt ƒë·∫ßu -->
<button id="start-btn" onclick="startQuiz()">B·∫ÆT ƒê·∫¶U</button>
<div id="quiz"></div>

<!-- Khu v·ª±c c√¢u h·ªèi -->
<div id="quiz-area" class="hidden">
    <h3 id="counter"></h3>
    <h2 id="question-text"></h2>
    <div id="answers"></div>

    <button onclick="prevQuestion()">‚¨Ö Quay l·∫°i</button>
    <button onclick="nextQuestion()">Ti·∫øp ‚û°</button>
    <button onclick="submitQuiz()" style="float:right;background:green;color:white;">N·ªôp b√†i</button>
</div>

<script>
let questions = [];
let currentIndex = 0;
let selectedAnswers = {}; 
let timeLeft = 20 * 60; // 20 ph√∫t

// ----------------------------
// B·∫ÆT ƒê·∫¶U
// ----------------------------
function startQuiz() {
    document.getElementById("start-btn").classList.add("hidden");
    loadQuestions();
    startTimer();
}

// ----------------------------
// ƒê·ªíNG H·ªí ƒê·∫æM NG∆Ø·ª¢C
// ----------------------------
function startTimer() {
    setInterval(() => {
        timeLeft--;
        let m = Math.floor(timeLeft / 60);
        let s = timeLeft % 60;
        document.getElementById("timer").innerText = `‚è∞ ${m}:${s < 10 ? '0'+s : s}`;

        if (timeLeft <= 0) submitQuiz();
    }, 1000);
}

// ----------------------------
// L·∫§Y 20 C√ÇU RANDOM T·ª™ API
// ----------------------------
async function loadQuestions() {
    let res = await fetch("/quiz/random");
    questions = await res.json();
    questions = questions.map(q => {
        return {
            ...q,
            choices: (typeof q.choices === "string") ? JSON.parse(q.choices) : q.choices,
            answer_key: (typeof q.answer_key === "string") ? JSON.parse(q.answer_key) : q.answer_key
        };
    });
    document.getElementById("quiz-area").classList.remove("hidden");
    showQuestion();
}

// ----------------------------
// HI·ªÇN TH·ªä C√ÇU H·ªéI
// ----------------------------
function showQuestion() {
    let q = questions[currentIndex];

    document.getElementById("counter").innerText =
        `C√¢u ${currentIndex + 1} / ${questions.length}`;

    document.getElementById("question-text").innerText = q.text;

    let answersDiv = document.getElementById("answers");
    answersDiv.innerHTML = "";

    q.choices.forEach(ch => {
        let div = document.createElement("div");
        div.className = "answer";
        div.innerText = `${ch.id}. ${ch.label}`;
        
        if (selectedAnswers[currentIndex] === ch.id) {
            div.classList.add("selected");
        }

        div.onclick = () => {
            selectedAnswers[currentIndex] = ch.id;
            showQuestion();
        };

        answersDiv.appendChild(div);
    });
}

// ----------------------------
// TI·∫æP + QUAY L·∫†I
// ----------------------------
function nextQuestion() {
    if (currentIndex < questions.length - 1) {
        currentIndex++;
        showQuestion();
    }
}

function prevQuestion() {
    if (currentIndex > 0) {
        currentIndex--;
        showQuestion();
    }
}

// ----------------------------
// N·ªòP B√ÄI
// ----------------------------
function submitQuiz() {
    document.getElementById("quiz-area").innerHTML = "";

    let score = 0;
    let resultHTML = "<h2>üìä K·∫øt qu·∫£ b√†i thi</h2>";

    questions.forEach((q, idx) => {
        let userAnswer = selectedAnswers[idx];
        let correctAnswer = q.answer_key[0];

        let isCorrect = userAnswer === correctAnswer;
        if (isCorrect) score++;

        resultHTML += `
            <div style="border:1px solid #ccc; padding:10px; margin:10px 0;">
                <b>C√¢u ${idx + 1}:</b> ${q.text}<br>
                <b>B·∫°n ch·ªçn:</b> 
                <span style="color:${isCorrect ? 'green' : 'red'}">
                    ${userAnswer ?? "Ch∆∞a ch·ªçn"}
                </span><br>
                <b>ƒê√°p √°n ƒë√∫ng:</b> 
                <span style="color:green">${q.choices.find(c => c.id === correctAnswer).label}</span>
            </div>
        `;
    });

    resultHTML = `
        <h2>üéâ B·∫°n ƒë∆∞·ª£c ${score} / ${questions.length} ƒëi·ªÉm</h2>
    ` + resultHTML;

    document.body.innerHTML = resultHTML;
}
</script src="frontend_src_api.js"></script>

</body>
</html>
